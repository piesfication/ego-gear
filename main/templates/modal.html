<!-- Modal -->
<div id="crudModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div id="crudModalContent" class="bg-white rounded-lg shadow-lg
     w-full sm:w-11/12 md:w-3/4 lg:w-2/3 xl:w-1/2 max-h-screen overflow-y-auto">
    <!-- Modal header -->
    <div class="flex items-center justify-between p-4 border-b">
      <div>
        <h3 class="text-xl font-semibold text-gray-900">
          Add New Gear
        </h3>
        <p class="text-sm text-gray-600 mt-1">Share your latest gear creations with fellow strikers</p>
      </div>
      <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onclick="hideModal()">
        <svg aria-hidden="true" class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
        </svg>
        <span class="sr-only">Close modal</span>
      </button>
    </div>
    <!-- Modal body -->

    <div class="px-6 py-4 space-y-6 form-style">

      <form id="productForm">

        {% csrf_token %}

        <div class="mb-4">
          <label for="name" class="block text-sm font-medium text-gray-700">Name</label>
          <input type="text" id="name" name="name" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter gear name" required>
        </div>

        <div class="mb-4">
          <label for="price" class="block text-sm font-medium text-gray-700">Price</label>
          <input type="number" id="price" name="price"
                class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                placeholder="Enter price" min="0" required>
        </div>

        <div class="mb-4">
          <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
          <textarea id="description" name="description" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="Enter gear description" required></textarea>
        </div>

        <div class="mb-4">
          <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
          <select id="category" name="category" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" required>
            <option value="">Choose a category</option>
            <option value="Finisher">Finisher</option>
            <option value="Speedster">Speedster</option>
            <option value="Playmaker">Playmaker</option>
            <option value="Reinforcer">Reinforcer</option>
            <option value="Strategist">Strategist</option>
            <option value="Specialist">Specialist</option>
          </select>
        </div>

        <div class="mb-4">
          <label for="thumbnail" class="block text-sm font-medium text-gray-700">Thumbnail URL</label>
          <input type="url" id="thumbnail" name="thumbnail" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" placeholder="https://example.com/image.jpg">
        </div>

        <div class="mb-4">
          <div class="flex items-center">
            <input id="is_featured" name="is_featured" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded">
            <label for="is_featured" class="ml-2 text-sm font-medium text-gray-900">Featured Gear</label>
          </div>
        </div>

        <!-- Stock -->
        <div class="mb-4">
          <label for="stock" class="block text-sm font-medium text-gray-700">Stock</label>
          <input type="number" id="stock" name="stock"
                class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                placeholder="Enter stock quantity" min="0" required>
        </div>

        <!-- Brand -->
        <div class="mb-4">
          <label for="brand" class="block text-sm font-medium text-gray-700">Brand</label>
          <input type="text" id="brand" name="brand"
                class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2"
                placeholder="Enter brand name (optional)">
        </div>

      </form>

    </div>
    <!-- Modal footer -->
    <div class="flex flex-col sm:flex-row gap-4 p-6 border-t border-gray-200 rounded-b">
      <button type="button" id="cancelButton" class="order-2 sm:order-1 px-6 py-3 border border-gray-300 text-gray-700 rounded-md font-medium hover:bg-gray-50 transition-colors text-center" onclick="hideModal()">Cancel</button>
      <button type="submit" id="submitProduct" form="productForm" class="order-1 sm:order-2 flex-1 bg-blue-600 text-white px-6 py-3 rounded-md font-medium hover:bg-blue-700 transition-colors">Unleash Gear </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="hidden fixed inset-0 z-50 w-full flex items-center justify-center bg-gray-800 bg-opacity-50">
  <div class="bg-white rounded-lg shadow-lg w-full sm:w-96 max-w-lg">
    <div class="p-6 text-center">
      <svg class="mx-auto mb-4 w-12 h-12 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z" />
      </svg>
      <h3 class="mb-5 text-lg font-normal text-gray-700">Are you sure you want to delete this gear?</h3>

      <div class="flex justify-center gap-4">
        <button id="confirmDeleteBtn"
          type="button"
          class="px-5 py-2.5 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">
          Yes, delete
        </button>
        <button
          type="button"
          onclick="hideDeleteModal()"
          class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>


<script>

  let deleteProductId = null;
  let editingProductId = null; // untuk simpan ID produk yang sedang diedit

// buka modal edit
  function showEditModal(productId) {
    const product = allProductData.find(p => p.id === productId);
    if (!product) return;

    // isi form dengan data produk
    document.querySelector("#name").value = product.name;
    document.querySelector("#description").value = product.description;
    document.querySelector("#category").value = product.category;
    document.querySelector("#thumbnail").value = product.thumbnail;
    document.querySelector("#price").value = product.price;
    document.querySelector("#stock").value = product.stock;
    document.querySelector("#brand").value = product.brand;
    document.querySelector("#is_featured").checked = product.is_featured;

    // ubah judul modal
    document.querySelector("#crudModal h3").textContent = "Edit Gear";

    editingProductId = productId;
    showModal();

    console.log('Product Data:', product);
  }

  // event submit form
  // document.querySelector("#productForm").addEventListener("submit", async function(e) {
  //   e.preventDefault();
  //   const form = e.target;
  //   const formData = new FormData(form);

  //   let url = editingProductId
  //     ? `/edit-product-ajax/${editingProductId}/`
  //     : "{% url 'main:create_product_ajax' %}";

  //   const response = await fetch(url, {
  //     method: "POST",
  //     headers: { "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value },
  //     body: formData,
  //   });

  //   const data = await response.json();

  //   if (data.success) {
  //     hideModal();
  //     showToast(editingProductId ? "Gear updated!" : "Gear added!", "", "success");
  //     editingProductId = null;
  //     form.reset();

  //     // biar main.html refresh product list
  //     document.dispatchEvent(new CustomEvent("productAdded"));
  //   } else {
  //     showToast("Error", data.message || "Failed to save gear", "error");
  //   }
  // });

  function showDeleteModal(productId) {
    deleteProductId = productId;
    const modal = document.getElementById('deleteModal');
    modal.classList.remove('hidden');
  }

  function hideDeleteModal() {
    const modal = document.getElementById('deleteModal');
    modal.classList.add('hidden');
    deleteProductId = null;
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.startsWith(name + "=")) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  

  async function confirmDelete() {
    if (!deleteProductId) return;

    try {
      const response = await fetch(`/delete-product-ajax/${deleteProductId}/`, {
        method: "DELETE",
        headers: {
          "X-CSRFToken": getCookie("csrftoken"),
        },
      });

      if (response.ok) {
        hideDeleteModal();
        showToast("Gear deleted successfully!", "", "success");

        // Notify main page to refresh product list
        document.dispatchEvent(new CustomEvent("productDeleted", { detail: { id: deleteProductId } }));
      } else {
        showToast("Failed to delete gear.", "", "error");
      }
    } catch (error) {
      console.error("Error deleting product:", error);
      showToast("Something went wrong.", "", "error");
    }
  }

  document.getElementById("confirmDeleteBtn").addEventListener("click", confirmDelete);


  function showModal() {
      const modal = document.getElementById('crudModal');
      const modalContent = document.getElementById('crudModalContent');

      modal.classList.remove('hidden'); 
      setTimeout(() => {
        modalContent.classList.remove('opacity-0', 'scale-95');
        modalContent.classList.add('opacity-100', 'scale-100');
      }, 50); 
  }

  function hideModal() {
      const modal = document.getElementById('crudModal');
      const modalContent = document.getElementById('crudModalContent');

      const form = document.querySelector("#productForm");
      form.reset();

      // ðŸ”¹ Reset state edit biar balik ke mode "add"
      editingProductId = null;

      // ðŸ”¹ Ubah judul modal balik ke "Add Gear"
      document.querySelector("#crudModal h3").textContent = "Add Gear";
      modalContent.scrollTop = 0;

      modalContent.classList.remove('opacity-100', 'scale-100');
      modalContent.classList.add('opacity-0', 'scale-95');

      setTimeout(() => {
        modal.classList.add('hidden');
      }, 150); 
  }

  document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const submitButton = document.getElementById('submitProduct');
  submitButton.disabled = true; // Prevent multiple submissions

  const formData = new FormData(form);
  const url = editingProductId
    ? `/edit-product-ajax/${editingProductId}/`
    : '{% url "main:create_product_ajax" %}';

  try {
    const response = await fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': getCookie('csrftoken') },
      body: formData,
    });

    const data = await response.json();

    if (data.success) {
      hideModal();
      // Show different toast messages for add vs. edit
      const toastMessage = editingProductId ? 'Gear updated successfully!' : 'Gear added successfully!';
      showToast(toastMessage, '', 'success');
      document.dispatchEvent(new CustomEvent('productAdded'));
    } else {
      showToast('Error', data.message || 'Failed to save gear', 'error');
    }
  } catch (error) {
    console.error('Error saving product:', error);
    showToast('Error', 'Something went wrong.', 'error');
  } finally {
    submitButton.disabled = false; // Re-enable button
  }
});

  // async function addProductEntry() {
  //   await fetch("{% url 'main:create_product_ajax' %}", {
  //     method: "POST",
  //     body: new FormData(document.querySelector('#productForm')),
  //   })

  //   document.getElementById("productForm").reset();
  //   hideModal();
      
  //   // Show toast notification
  //   showToast('Gear added successfully!', '', 'success');

  //   // Dispatch custom event to notify main.html about new data
  //   document.dispatchEvent(new CustomEvent('productAdded'));

  //   return false;
  // }

  //   document.getElementById("productForm").addEventListener("submit", function(e) {
  //       e.preventDefault();
  //       addProductEntry();
  //   })

</script>